<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø³Ù‡Ù… Ø²Ù…ÛŒÙ†</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg: #f9fafb;
      --text: #111827;
      --box: #fff;
      --primary: #0ea5e9;
      --shadow: #cbd5e1;
    }

    .dark-mode {
      --bg: #1e293b;
      --text: #f8fafc;
      --box: #334155;
      --primary: #38bdf8;
      --shadow: #475569;
    }

    body {
      font-family: 'Vazirmatn';
      background-color: var(--bg);
      color: var(--text);
      padding: 2rem;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }

    h2 {
      font-family: Vazirmatn;
      padding: 2rem;
      margin: 2rem;
      color: var(--text);
    }

    .p-title {
      text-decoration: underline;
      text-align: center;
      font-family: Vazirmatn;
      font-weight: bold;
      font-size: 28px;
      background: linear-gradient(90deg, #9945FF, #0ea5e9, #14f195);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
      animation: animateGradient 3s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    @keyframes animateGradient {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    .p-title:hover {
      background: linear-gradient(90deg, #b366ff, #9a00ff, #0746f8);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
      transition: background 0.8s ease;
    }

    @media print {
      .actions,
      .dark-toggle {
        display: none !important;
      }
      .p-print {
        display: block;
        color: gray;
        font-family: Vazirmatn;
        font-weight: bold;
        text-align: center;
        justify-content: center;
        align-items: center;
      }
      .p-title {
        display: none !important;
      }
    }

    @media screen {
      .p-print {
        display: none !important;
      }
      .p-title {
        display: block !important;
      }
    }

    .container {
      max-width: 88%;
      margin: auto;
      background: var(--box);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 10px var(--shadow);
    }

    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    label {
      min-width: 160px;
      font-weight: 700;
    }

    input[type="number"],
    input[type="text"] {
      flex: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--shadow);
      font-size: 1rem;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      direction: rtl;
    }

    th,
    td {
      padding: 0.75rem;
      border: 1px solid var(--shadow);
      text-align: center;
    }

    th {
      background: var(--primary);
      color: #fff;
      font-weight: 700;
    }

    .actions {
      text-align: center;
      margin-top: 2rem;
    }

    button {
      background-color: var(--primary);
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      margin: 0.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity 0.3s ease;
      font-family: Vazirmatn;
      font-weight: bold;
    }

    button:hover {
      opacity: 0.85;
      color: var(--primary);
      background-color: var(--box);
      border: 2px solid var(--primary);
    }

    #unitInputs {
      margin-top: 1rem;
      overflow-x: auto;
    }

    .responsive-table {
      overflow-x: auto;
      overflow-y: auto;
    }

    /* Toggle Dark Mode Button */
    .dark-toggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      font-size: 1.6rem;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--primary);
      z-index: 1000;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100%;
      background: var(--box);
      box-shadow: -3px 0 10px rgba(0, 0, 0, 0.3);
      transition: right 0.3s ease-in-out;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar.active {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .sidebar-header input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--shadow);
    }

    .clear-btn {
      background: #ff4d4d;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }

    .toggle-btn {
      position: fixed;
      right: 20px;
      top: 20px;
      z-index: 1100;
      padding: 10px 15px;
      font-size: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .history-list {
      max-height: calc(100vh - 150px);
      overflow-y: auto;
    }

    .history-item {
      background: var(--box);
      border: 1px solid var(--shadow);
      border-radius: 6px;
      margin-bottom: 10px;
      padding: 10px;
      position: relative;
    }

    .history-item .delete-entry {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: red;
      font-size: 16px;
      cursor: pointer;
    }

    .history-item-content {
      padding-right: 25px;
    }

    .history-item-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .history-item-details {
      font-size: 0.9rem;
      color: var(--text);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .container {
        padding: 1rem;
      }

      .form-group {
        flex-direction: column;
        align-items: stretch;
        margin: 1rem;
      }

      label {
        min-width: auto;
        width: 100%;
      }

      input[type="number"],
      input[type="text"],
      button {
        width: 100%;
        font-size: 1rem;
      }

      canvas#myChart {
        max-width: 100% !important;
      }

      .dark-toggle {
        font-size: 1.2rem;
        border: none;
        position: absolute;
        top: 0.1rem;
        max-width: fit-content;
        max-height: fit-content;
        z-index: 0;
      }

      .dark-toggle:hover {
        background: none;
        border: none;
        opacity: 50%;
        z-index: 0;
      }

      table th,
      table td {
        font-size: 0.85rem;
        padding: 0.3rem;
      }

      .sidebar {
        width: 85%;
        right: -85%;
      }

      .toggle-btn {
        right: 10px;
        top: 10px;
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

  <button class="dark-toggle" vazirmatn="ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©" onclick="toggleDarkMode()">ğŸŒ™/â˜€ï¸</button>
  <!-- Toggle Button -->
  <button id="toggleSidebar" class="toggle-btn">â˜° ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h2>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h2>
      <input type="text" id="searchHistory" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." />
      <button id="clearHistory" class="clear-btn">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
    </div>
    <div id="historyList" class="history-list">
      <!-- Dynamically added history entries will appear here -->
    </div>
  </div>

  <h1>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø³Ù‡Ù… Ø²Ù…ÛŒÙ† Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡ (Ù‚Ø¯Ø±Ø§Ù„Ø³Ù€Ù€Ù‡Ù…) </h1>

  <div class="container">
    <p class="p-title">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚Ø¯Ø±Ø§Ù„Ø³Ù€Ù€Ù‡Ù… Ø²Ù…ÛŒÙ† ØŒ Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†  | Ù¾ÙˆÛŒØ§Ù† </p>
    <p class="p-print">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚Ø¯Ø±Ø§Ù„Ø³Ù€Ù€Ù‡Ù… Ø²Ù…ÛŒÙ† ØŒ Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†  | Ù¾ÙˆÛŒØ§Ù† </p>

    <div class="form-group">
      <label for="landArea">Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÛŒÙ†:</label>
      <input type="number" id="landArea" placeholder="Ù…Ø«Ù„Ø§Ù‹ 300" min="0" />
    </div>

    <div class="form-group">
      <label for="pricePerMeter">Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ± Ù…Ø±Ø¨Ø¹:</label>
      <input type="text" id="pricePerMeter" placeholder="Ù…Ø«Ù„Ø§Ù‹ 70,000,000" oninput="formatInput(this)" />
    </div>

    <div class="form-group">
      <label for="totalBudget">Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
      <input type="text" id="totalBudget" placeholder="Ù…Ø«Ù„Ø§Ù‹ 4,000,000,000" oninput="formatInput(this)" />
    </div>

    <hr />

    <div class="form-group">
      <label for="coef_parking">Ø¶Ø±ÛŒØ¨ Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯:</label>
      <input type="number" id="coef_parking" step="0.01" value="0.5" min="0" />
    </div>

    <div class="form-group">
      <label for="coef_storage">Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¨Ø§Ø±ÛŒ:</label>
      <input type="number" id="coef_storage" step="0.01" value="0.3" min="0" />
    </div>

    <div class="form-group">
      <label for="coef_balcony">Ø¶Ø±ÛŒØ¨ Ø¨Ø§Ù„Ú©Ù†:</label>
      <input type="number" id="coef_balcony" step="0.01" value="0.2" min="0" />
    </div>

    <hr />

    <div class="form-group">
      <label for="unitCount">ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§:</label>
      <input type="number" id="unitCount" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3" />
      <button type="button" onclick="generateUnits()">Ø«Ø¨Øª ÙˆØ§Ø­Ø¯Ù‡Ø§</button>
    </div>

    <div id="unitInputs" class="responsive-table" aria-live="polite"></div>

    <div class="actions">
      <button type="button" onclick="calculate()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
      <button type="button" onclick="exportPDF()">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
      <button type="button" onclick="exportExcel()">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
      <button type="button" onclick="clearData()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
    </div>

    <div id="results" class="responsive-table" aria-live="polite"></div>

    <canvas id="myChart" style="max-width:40%; margin:2rem;"></canvas>
  </div>

  <script>
    let isLoadingFromHistory = false;

    // Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }

    // ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ (ÙØ§Ø±Ø³ÛŒ)
    function formatInput(input) {
      let value = input.value.replace(/[^\d]/g, '');
      input.value = Number(value).toLocaleString('en-US');
    }

    function parseNumber(str) {
      return parseFloat(str.replace(/,/g, '')) || 0;
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ ÙˆØ±ÙˆØ¯ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§
    function generateUnits() {
      const count = parseInt(document.getElementById('unitCount').value);
      const container = document.getElementById('unitInputs');
      container.innerHTML = '';

      if (!count || count <= 0) {
        alert('Ù„Ø·ÙØ§Ù‹ ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      let table = `<table>
        <thead>
          <tr>
            <th>ÙˆØ§Ø­Ø¯</th>
            <th>Ù†Ø§Ù… Ù…Ø§Ù„Ú©</th>
            <th>Ù…ØªØ±Ø§Ú˜ Ù…ÙÛŒØ¯</th>
            <th>Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯</th>
            <th>Ø§Ù†Ø¨Ø§Ø±ÛŒ</th>
            <th>Ø¨Ø§Ù„Ú©Ù†</th>
          </tr>
        </thead><tbody>`;

      for (let i = 1; i <= count; i++) {
        table += `<tr>
          <td>${i}</td>
          <td><input type="text" id="owner_${i}" placeholder="Ù†Ø§Ù… Ù…Ø§Ù„Ú©" vazirmatn="Ù†Ø§Ù… Ù…Ø§Ù„Ú© ÙˆØ§Ø­Ø¯ ${i}" /></td>
          <td><input type="number" id="useful_${i}" min="0" step="0.01" vazirmatn="Ù…ØªØ±Ø§Ú˜ Ù…ÙÛŒØ¯ ÙˆØ§Ø­Ø¯ ${i}" /></td>
          <td><input type="number" id="parking_${i}" min="0" step="0.01" vazirmatn="Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯ ÙˆØ§Ø­Ø¯ ${i}" /></td>
          <td><input type="number" id="storage_${i}" min="0" step="0.01" vazirmatn="Ø§Ù†Ø¨Ø§Ø±ÛŒ ÙˆØ§Ø­Ø¯ ${i}" /></td>
          <td><input type="number" id="balcony_${i}" min="0" step="0.01" vazirmatn="Ø¨Ø§Ù„Ú©Ù† ÙˆØ§Ø­Ø¯ ${i}" /></td>
        </tr>`;
      }
      table += '</tbody></table>';
      container.innerHTML = table;

      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ù‚Ø¨Ù„ÛŒ
      loadUnitsFromLocalStorage(count);
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø§Ø² localStorage
    function loadUnitsFromLocalStorage(count) {
      const data = JSON.parse(localStorage.getItem('landShareData') || '{}');
      if (!data.units || data.units.length !== count) return;

      for (let i = 1; i <= count; i++) {
        const unit = data.units[i - 1];
        if (!unit) continue;
        document.getElementById(`owner_${i}`).value = unit.owner || '';
        document.getElementById(`useful_${i}`).value = unit.useful || '';
        document.getElementById(`parking_${i}`).value = unit.parking || '';
        document.getElementById(`storage_${i}`).value = unit.storage || '';
        document.getElementById(`balcony_${i}`).value = unit.balcony || '';
      }
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù‡Ù… Ù‡Ø§ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
    function calculate() {
      // ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
      const landArea = parseNumber(document.getElementById('landArea').value);
      const pricePerMeter = parseNumber(document.getElementById('pricePerMeter').value);
      const totalBudget = parseNumber(document.getElementById('totalBudget').value);
      const coef_parking = parseFloat(document.getElementById('coef_parking').value) || 0;
      const coef_storage = parseFloat(document.getElementById('coef_storage').value) || 0;
      const coef_balcony = parseFloat(document.getElementById('coef_balcony').value) || 0;
      const count = parseInt(document.getElementById('unitCount').value);

      if (!landArea || !pricePerMeter || !totalBudget || !count || count <= 0) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      // Ø¬Ù…Ø¹ Ù…Ø³Ø§Ø­Øª ÙˆØ²Ù†ÛŒ Ú©Ù„
      let totalWeightedArea = 0;
      const units = [];

      // Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§
      for (let i = 1; i <= count; i++) {
        const owner = document.getElementById(`owner_${i}`).value.trim() || `ÙˆØ§Ø­Ø¯ ${i}`;
        const useful = parseFloat(document.getElementById(`useful_${i}`).value) || 0;
        const parking = parseFloat(document.getElementById(`parking_${i}`).value) || 0;
        const storage = parseFloat(document.getElementById(`storage_${i}`).value) || 0;
        const balcony = parseFloat(document.getElementById(`balcony_${i}`).value) || 0;

        const weightedArea = useful + parking * coef_parking + storage * coef_storage + balcony * coef_balcony;

        units.push({ owner, useful, parking, storage, balcony, weightedArea });
        totalWeightedArea += weightedArea;
      }

      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ùˆ Ø§Ø±Ø²Ø´ Ù‡Ø± ÙˆØ§Ø­Ø¯
      for (const u of units) {
        u.sharePercent = (u.weightedArea / totalWeightedArea) * 100;
        u.shareValue = (u.sharePercent / 100) * totalBudget;
      }

      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± LocalStorage
      const calculationData = {
        landArea,
        pricePerMeter,
        totalBudget,
        coef_parking,
        coef_storage,
        coef_balcony,
        count,
        units,
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem('landShareData', JSON.stringify(calculationData));
      
      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
      if (!isLoadingFromHistory) {
        saveToHistory(calculationData);
        }

      
      // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
      displayResults(units, landArea, pricePerMeter, totalBudget, totalWeightedArea);
      drawChart(units);
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
    function displayResults(units, landArea, pricePerMeter, totalBudget, totalWeightedArea) {
      const container = document.getElementById('results');
      container.innerHTML = '';

      let sumUseful = 0, sumParking = 0, sumStorage = 0, sumBalcony = 0;
      units.forEach(u => {
        sumUseful += u.useful;
        sumParking += u.parking;
        sumStorage += u.storage;
        sumBalcony += u.balcony;
      });

      let html = `<table>
        <thead>
          <tr>
            <th>ÙˆØ§Ø­Ø¯</th>
            <th>Ù†Ø§Ù… Ù…Ø§Ù„Ú©</th>
            <th>Ù…ØªØ±Ø§Ú˜ Ù…ÙÛŒØ¯ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</th>
            <th>Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</th>
            <th>Ø§Ù†Ø¨Ø§Ø±ÛŒ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</th>
            <th>Ø¨Ø§Ù„Ú©Ù† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</th>
            <th>Ù…Ø³Ø§Ø­Øª ÙˆØ²Ù†ÛŒ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</th>
            <th>Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… (%)</th>
            <th>Ø§Ø±Ø²Ø´ Ø³Ù‡Ù… (ØªÙˆÙ…Ø§Ù†)</th>
          </tr>
        </thead>
        <tbody>`;

      units.forEach((u, i) => {
        html += `<tr>
          <td>${i + 1}</td>
          <td>${u.owner}</td>
          <td>${u.useful.toLocaleString('fa-IR')}</td>
          <td>${u.parking.toLocaleString('fa-IR')}</td>
          <td>${u.storage.toLocaleString('fa-IR')}</td>
          <td>${u.balcony.toLocaleString('fa-IR')}</td>
          <td>${u.weightedArea.toLocaleString('fa-IR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td>${u.sharePercent.toLocaleString('fa-IR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%</td>
          <td>${Math.round(u.shareValue).toLocaleString('fa-IR')}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      html += `
      <table class="summary-table">
        <thead>
          <hr>
          <h2>Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª Ù…Ù„Ú©ÛŒ Ø´Ù…Ø§ : </h2>
          <tr>
            <th>Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ù…Ù‚Ø¯Ø§Ø±</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ù…Ø¬Ù…ÙˆØ¹ Ù…ØªØ±Ø§Ú˜ Ù…ÙÛŒØ¯</td>
            <td>${sumUseful.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
          <tr>
            <td>Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯</td>
            <td>${sumParking.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
          <tr>
            <td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù†Ø¨Ø§Ø±ÛŒ</td>
            <td>${sumStorage.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
          <tr>
            <td>Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø§Ù„Ú©Ù†</td>
            <td>${sumBalcony.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
          <tr>
            <td>Ù…Ø³Ø§Ø­Øª Ø²Ù…ÛŒÙ†</td>
            <td>${landArea.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
          <tr>
            <td>Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ± Ù…Ø±Ø¨Ø¹ Ø²Ù…ÛŒÙ†</td>
            <td>${pricePerMeter.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡</td>
            <td>${totalBudget.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø³Ø§Ø­Øª ÙˆØ²Ù†ÛŒ</td>
            <td>${totalWeightedArea.toLocaleString('fa-IR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</td>
          </tr>
        </tbody>
      </table>`;

      container.innerHTML = html;
    }

    // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±ØµØ¯ Ø³Ù‡Ù…
    function drawChart(units) {
      const ctx = document.getElementById('myChart').getContext('2d');

      if (window.myPieChart) {
        window.myPieChart.destroy();
      }

      const labels = units.map((u, i) => `ÙˆØ§Ø­Ø¯ ${i + 1} (${u.owner})`);
      const data = units.map(u => u.sharePercent);

      window.myPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ù‡Ø± ÙˆØ§Ø­Ø¯',
            data,
            backgroundColor: generateColors(data.length),
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true },
          }
        }
      });
    }

    // ØªÙˆÙ„ÛŒØ¯ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
    function generateColors(count) {
      const baseColors = [
        '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
        '#59a14f', '#edc949', '#af7aa1', '#ff9da7',
        '#9c755f', '#bab0ab'
      ];
      let colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    }

    // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡
    function saveToHistory(data) {
      let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      const now = new Date();
      const persianDate = now.toLocaleString('fa-IR');
      
      const historyItem = {
        ...data,
        displayDate: persianDate,
        timestamp: now.getTime()
      };
      
      history.unshift(historyItem);
      
      // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ 20 Ù…ÙˆØ±Ø¯ Ø¢Ø®Ø±
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      localStorage.setItem('calculationHistory', JSON.stringify(history));
      renderHistory();
    }

    // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª
    function renderHistory() {
      const historyContainer = document.getElementById('historyList');
      let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');

      if (history.length === 0) {
        historyContainer.innerHTML = '<div class="history-item"><div class="history-item-content">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div></div>';
        return;
      }

      historyContainer.innerHTML = '';
      
      history.forEach((item, idx) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const totalValue = item.units.reduce((sum, unit) => sum + unit.shareValue, 0);
        
        historyItem.innerHTML = `
          <div class="history-item-content">
            <div class="history-item-title">Ù…Ø­Ø§Ø³Ø¨Ù‡ ${idx + 1} - ${item.displayDate}</div>
            <div class="history-item-details">
              <div>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§: ${item.count}</div>
              <div>Ù…Ø³Ø§Ø­Øª Ø²Ù…ÛŒÙ†: ${item.landArea.toLocaleString('fa-IR')} Ù…ØªØ± Ù…Ø±Ø¨Ø¹</div>
              <div>Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„: ${item.totalBudget.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</div>
            </div>
          </div>
          <button class="delete-entry" onclick="deleteHistoryItem(${idx})">âœ–</button>
          <button class="load-btn" onclick="loadHistoryItem(${idx})">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
        `;
        
        historyContainer.appendChild(historyItem);
      });
    }

    // Ø­Ø°Ù ÛŒÚ© Ù…ÙˆØ±Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡
    function deleteHistoryItem(index) {
      let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
      history.splice(index, 1);
      localStorage.setItem('calculationHistory', JSON.stringify(history));
      renderHistory();
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒÚ© Ù…ÙˆØ±Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡
    function loadHistoryItem(index) {
      let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
      const item = history[index];
      
      if (!item) return;

      isLoadingFromHistory = true;

      // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
      document.getElementById('landArea').value = item.landArea;
      document.getElementById('pricePerMeter').value = item.pricePerMeter.toLocaleString('en-US');
      document.getElementById('totalBudget').value = item.totalBudget.toLocaleString('en-US');
      document.getElementById('coef_parking').value = item.coef_parking;
      document.getElementById('coef_storage').value = item.coef_storage;
      document.getElementById('coef_balcony').value = item.coef_balcony;
      document.getElementById('unitCount').value = item.count;
      
      // ØªÙˆÙ„ÛŒØ¯ ÙˆØ§Ø­Ø¯Ù‡Ø§
      generateUnits();
      
      // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² ÛŒÚ© ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡
      setTimeout(() => {
        item.units.forEach((unit, i) => {
          const idx = i + 1;
          document.getElementById(`owner_${idx}`).value = unit.owner || '';
          document.getElementById(`useful_${idx}`).value = unit.useful || '';
          document.getElementById(`parking_${idx}`).value = unit.parking || '';
          document.getElementById(`storage_${idx}`).value = unit.storage || '';
          document.getElementById(`balcony_${idx}`).value = unit.balcony || '';
        });
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ØªØ§ÛŒØ¬
        calculate();
        isLoadingFromHistory = false;

      }, 100);
    }

    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø±ÙØ±Ø´ ØµÙØ­Ù‡
    function clearData() {
      if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù…ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
        localStorage.removeItem('landShareData');
        location.reload();
      }
    }

    function updateTotalBudget() {
      const landArea = parseNumber(document.getElementById('landArea').value);
      const pricePerMeter = parseNumber(document.getElementById('pricePerMeter').value);

      if (landArea && pricePerMeter) {
          const totalBudget = landArea * pricePerMeter;
          document.getElementById('totalBudget').value = totalBudget.toLocaleString('en-US');
      }
    }

    function updatePricePerMeter() {
      const landArea = parseNumber(document.getElementById('landArea').value);
      const totalBudget = parseNumber(document.getElementById('totalBudget').value);

      if (landArea && totalBudget) {
          const pricePerMeter = totalBudget / landArea;
          document.getElementById('pricePerMeter').value = pricePerMeter.toLocaleString('en-US');
      }
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ù‡ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
    document.getElementById('landArea').addEventListener('input', updateTotalBudget);
    document.getElementById('pricePerMeter').addEventListener('input', updateTotalBudget);
    document.getElementById('totalBudget').addEventListener('input', updatePricePerMeter);

    // Ø®Ø±ÙˆØ¬ÛŒ PDF Ø¨Ø§ jsPDF
    function exportPDF() {
      const container = document.getElementById('results');
      if (!container || !container.innerHTML.trim()) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯');
        return;
      }

      const element = document.querySelector(".container");

      // Ø­Ø°Ù margin Ùˆ padding Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ÙØ§ØµÙ„Ù‡ Ø®Ø§Ù„ÛŒ Ø¯Ø± PDF
      element.style.margin = "10";
      element.style.padding = "10";
      element.style.width = "100%";
      element.style.height = "100%";

      const opt = {
        margin: [0, 0, 0, 0],
        filename: 'land-share.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          scrollY: 0,
          scrollX: 0,
          useCORS: true
        },
        jsPDF: {
          unit: 'pt',
          format: 'a4',
          orientation: 'landscape'
        }
      };

      html2pdf().set(opt).from(element).save();
    }

    // Ø®Ø±ÙˆØ¬ÛŒ Excel Ø¨Ø§ SheetJS (xlsx)
    function exportExcel() {
      const data = JSON.parse(localStorage.getItem('landShareData') || '{}');
      if (!data.units) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯');
        return;
      }

      const wb = XLSX.utils.book_new();

      // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´ÛŒØª
      const ws_data = [
        ['ÙˆØ§Ø­Ø¯', 'Ù†Ø§Ù… Ù…Ø§Ù„Ú©', 'Ù…ØªØ±Ø§Ú˜ Ù…ÙÛŒØ¯', 'Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯', 'Ø§Ù†Ø¨Ø§Ø±ÛŒ', 'Ø¨Ø§Ù„Ú©Ù†', 'Ù…Ø³Ø§Ø­Øª ÙˆØ²Ù†ÛŒ', 'Ø¯Ø±ØµØ¯ Ø³Ù‡Ù…', 'Ø§Ø±Ø²Ø´ Ø³Ù‡Ù… (ØªÙˆÙ…Ø§Ù†)']
      ];

      data.units.forEach((u, i) => {
        ws_data.push([
          i + 1,
          u.owner,
          u.useful,
          u.parking,
          u.storage,
          u.balcony,
          u.weightedArea.toFixed(2),
          u.sharePercent.toFixed(2),
          u.shareValue.toFixed(0),
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø¨Ú© (Ø±Ù†Ú¯ Ùˆ ÙÙˆÙ†Øª) Ø¨Ù‡ ØµÙˆØ±Øª Ø³Ø§Ø¯Ù‡
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cell_address]) continue;

          if (R === 0) {
            // Ø³Ø·Ø± Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§ Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ùˆ Ø±Ù†Ú¯ Ù…ØªÙ† Ø³ÙÛŒØ¯
            ws[cell_address].s = {
              fill: { fgColor: { rgb: "FF000080" } },
              font: { color: { rgb: "FFFFFFFF" }, bold: true }
            };
          } else {
            // Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ø±Ù†Ú¯ Ù…ØªÙ† Ù…Ø´Ú©ÛŒ Ùˆ ÙÙˆÙ†Øª Ù…Ø¹Ù…ÙˆÙ„ÛŒ
            ws[cell_address].s = {
              font: { color: { rgb: "FF000000" } }
            };
          }
        }
      }

      XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§ÛŒØ¬ Ø³Ù‡Ù… Ø²Ù…ÛŒÙ†");

      XLSX.writeFile(wb, "land_share_result.xlsx");
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
    const toggleBtn = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    const clearBtn = document.getElementById("clearHistory");
    const searchInput = document.getElementById("searchHistory");

    // Toggle sidebar
    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("active");
    });

    // Clear all history
    clearBtn.addEventListener("click", () => {
      if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
        localStorage.removeItem("calculationHistory");
        renderHistory();
      }
    });

    // Search history
    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      document.querySelectorAll(".history-item").forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(query) ? "block" : "none";
      });
    });

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    document.addEventListener('DOMContentLoaded', () => {
      renderHistory();
      
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
      const data = JSON.parse(localStorage.getItem('landShareData') || '{}');
      if (!data.units) return;
      
      document.getElementById('landArea').value = data.landArea || '';
      document.getElementById('pricePerMeter').value = data.pricePerMeter ? Number(data.pricePerMeter).toLocaleString('en-US') : '';
      document.getElementById('totalBudget').value = data.totalBudget ? Number(data.totalBudget).toLocaleString('en-US') : '';
      document.getElementById('coef_parking').value = data.coef_parking || 0.5;
      document.getElementById('coef_storage').value = data.coef_storage || 0.3;
      document.getElementById('coef_balcony').value = data.coef_balcony || 0.2;
      document.getElementById('unitCount').value = data.count || '';

      if (data.count) {
        generateUnits();
        setTimeout(() => {
          calculate();
        }, 100);
      }
    });


  
    
  </script>
</body>
</html>
